<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>{{ app_name }} ‚Äî Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg:#0b0f17;
      --card:#121a27;
      --muted:#9fb3ce;
      --text:#e8f0ff;
      --green:#18c964;
      --red:#ff4d4f;
      --amber:#f5a524;
      --blue:#2f80ed;
      --vio:#8a63d2;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font:16px/1.5 system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;
      background:linear-gradient(180deg,#0b0f17 0%,#0e1522 100%) fixed;
      color:var(--text);
    }
    header{
      padding:24px 16px; text-align:center;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.2); backdrop-filter:blur(6px);
      position:sticky; top:0; z-index:3;
    }
    h1{margin:0;font-size:22px;letter-spacing:.3px}
    main{max-width:1100px;margin:24px auto;padding:0 12px}
    .card{
      background:var(--card); border:1px solid rgba(255,255,255,.06);
      border-radius:14px; padding:16px; margin-bottom:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row>*{flex:1}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px dashed rgba(255,255,255,.08);vertical-align:top}
    th{color:#bcd1ef;font-weight:600;text-align:left}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .ok{background:rgba(24,201,100,.18);color:#7bf3b2;border:1px solid rgba(24,201,100,.35)}
    .warn{background:rgba(245,165,36,.15);color:#ffc772;border:1px solid rgba(245,165,36,.35)}
    .err{background:rgba(255,77,79,.15);color:#ffadad;border:1px solid rgba(255,77,79,.35)}
    .dev{background:rgba(138,99,210,.18);color:#c9b5ff;border:1px solid rgba(138,99,210,.35)}
    .config{background:rgba(47,128,237,.15);color:#a8c7ff;border:1px solid rgba(47,128,237,.35)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button{
      background:#1a2333;color:#cfe1ff;border:1px solid rgba(255,255,255,.08);
      padding:8px 10px;border-radius:10px;cursor:pointer;transition:.15s;
    }
    button:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.15)}
    .danger{background:rgba(255,77,79,.08);color:#ffb4b5;border-color:rgba(255,77,79,.25)}
    .primary{background:rgba(47,128,237,.1);color:#bcd8ff;border-color:rgba(47,128,237,.35)}
    .success{background:rgba(24,201,100,.1);color:#9ef3c4;border-color:rgba(24,201,100,.35)}
    .vio{background:rgba(138,99,210,.1);color:#d9caff;border-color:rgba(138,99,210,.35)}
    .config-btn{background:rgba(47,128,237,.15);color:#a8c7ff;border-color:rgba(47,128,237,.35)}
    input[type="password"], input[type="text"], textarea, input[type="number"]{
      width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:#0e1522;color:#eaf2ff;outline:none;
    }
    .login{max-width:420px;margin:40px auto}
    .tx{font-family:ui-monospace,Consolas,Menlo,monospace;font-size:13px;color:#e0f4ff}
    .small{font-size:12px}
    .form-group{margin-bottom:16px}
    label{display:block;margin-bottom:6px;color:var(--muted)}
    .add-row{background:rgba(24,201,100,.1);color:#9ef3c4;border:1px dashed rgba(24,201,100,.4);margin-top:8px}
    .config-section{margin-bottom:24px}
    .config-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .config-title{font-size:18px;font-weight:600;color:#bcd1ef}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:var(--card);border-radius:16px;padding:24px;max-width:500px;width:90%;border:1px solid rgba(255,255,255,.1)}
    .modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:20px}
    .custom-action{display:flex;gap:8px;align-items:center;margin-top:8px}
    .custom-action input{flex:1}
  </style>
</head>
<body>
  <header>
    <h1>{{ app_name }} ‚Äî Admin</h1>
  </header>
  <main>

    {% if not session.is_admin %}
    <div class="card login">
      <h3>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
      <p class="muted small">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>
      {% if error %}<p class="err badge">{{ error }}</p>{% endif %}
      <form method="post" action="/admin">
        <p><input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞" autofocus></p>
        <p><button class="primary">–í–æ–π—Ç–∏</button></p>
      </form>
    </div>
    {% else %}

    <div class="row" style="margin-bottom:16px">
      <div><b>–í—Å–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤:</b> {{ devices|length }}</div>
      <div style="text-align:right">
        <a href="/admin/config" class="config-btn" style="text-decoration:none;padding:8px 12px;border-radius:8px;display:inline-block">üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥</a>
        <a href="/admin/logout" class="muted small" style="margin-left:16px">–í—ã–π—Ç–∏</a>
      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th>
            <th>–°–æ—Å—Ç–æ—è–Ω–∏–µ</th>
            <th>–ü–ª–∞—Ç–µ–∂–∏</th>
            <th>–ü–æ–ø—ã—Ç–∫–∏</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          {% for d in devices %}
          {% set active = d.sub_active or d.dev_mode %}
          <tr>
            <td>
              <div><b>{{ d.device_id }}</b></div>
              <div class="small muted">seen: {{ d.last_seen or "‚Äî" }}</div>
              <div class="small muted">created: {{ d.created_at or "‚Äî" }}</div>
            </td>
            <td>
              {% if d.dev_mode %}
                <span class="badge dev">DEV (–±–µ—Å—Å—Ä–æ—á–Ω–æ)</span>
              {% elif d.sub_active %}
                <span class="badge ok">–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
                <div class="small muted">–¥–æ: {{ d.sub_expires_at or "‚Äî" }}</div>
              {% else %}
                <span class="badge err">–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏</span>
              {% endif %}
            </td>
            <td class="tx">
              {% if d.last_tx or d.last_comment %}
                <div>TX: {{ d.last_tx or "‚Äî" }}</div>
                <div>–ö–æ–º–º: {{ d.last_comment or "‚Äî" }}</div>
                {% if d.selected_plan %}
                <div class="small muted">–ü–ª–∞–Ω: {{ d.selected_plan }}</div>
                {% endif %}
                <div class="small muted">–î–Ω–µ–π: {{ d.last_plan_days or "‚Äî" }}</div>
                <div class="small muted">–¶–µ–Ω–∞: {{ d.last_plan_price or "‚Äî" }}</div>
              {% else %}
                <span class="muted small">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
              {% endif %}
            </td>
            <td>
              <b>{{ d.free_left }}</b>
              <div class="small muted">–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ: 3</div>
            </td>
            <td class="actions">
              <!-- –ö–∞—Å—Ç–æ–º–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ -->
              <form method="post" action="/admin/action" class="custom-action">
                <input type="hidden" name="device_id" value="{{ d.device_id }}">
                <input type="hidden" name="action" value="grant_custom">
                <input type="number" name="plan_days" placeholder="–î–Ω–µ–π" min="1" max="365" style="width:80px;padding:4px 8px;font-size:14px">
                <button class="success" type="submit">–í—ã–¥–∞—Ç—å</button>
              </form>

              <!-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ -->
              <form method="post" action="/admin/action">
                <input type="hidden" name="device_id" value="{{ d.device_id }}">
                <input type="hidden" name="action" value="grant30">
                <button class="success">30 –¥–Ω.</button>
              </form>

              <form method="post" action="/admin/action">
                <input type="hidden" name="device_id" value="{{ d.device_id }}">
                <input type="hidden" name="action" value="grant7">
                <button class="success">7 –¥–Ω.</button>
              </form>

              <form method="post" action="/admin/action">
                <input type="hidden" name="device_id" value="{{ d.device_id }}">
                <input type="hidden" name="action" value="grant3">
                <button class="success">3 –¥–Ω.</button>
              </form>

              <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π -->
              <form method="post" action="/admin/action">
                <input type="hidden" name="device_id" value="{{ d.device_id }}">
                <input type="hidden" name="action" value="remove_sub">
                <button>–£–±—Ä–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
              </form>

              <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DEV —Ä–µ–∂–∏–º–æ–º -->
              <form method="post" action="/admin/action">
                <input type="hidden" name="device_id" value="{{ d.device_id }}">
                <input type="hidden" name="action" value="toggle_dev">
                <button class="vio">{% if d.dev_mode %}–û—Ç–∫–ª. DEV{% else %}–í–∫–ª. DEV{% endif %}</button>
              </form>

              <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ -->
              <form method="post" action="/admin/action">
                <input type="hidden" name="device_id" value="{{ d.device_id }}">
                <input type="hidden" name="action" value="reset_free">
                <button class="primary" title="–í–µ—Ä–Ω—É—Ç—å 3 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∏">‚Üª 3 –ø–æ–ø—ã—Ç–∫–∏</button>
              </form>

              <form method="post" action="/admin/action">
                <input type="hidden" name="device_id" value="{{ d.device_id }}">
                <input type="hidden" name="action" value="zero_free">
                <button class="warn" title="–û–±–Ω—É–ª–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏">0 –ø–æ–ø—ã—Ç–æ–∫</button>
              </form>

              <!-- –û—á–∏—Å—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π -->
              <form method="post" action="/admin/action" onsubmit="return confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–ª–∞—Ç–µ–∂–µ–π?');">
                <input type="hidden" name="device_id" value="{{ d.device_id }}">
                <input type="hidden" name="action" value="clear_tx">
                <button class="warn" title="–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é TX">–û—á–∏—Å—Ç–∏—Ç—å TX</button>
              </form>

              <!-- –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
              <form method="post" action="/admin/action" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ?');">
                <input type="hidden" name="device_id" value="{{ d.device_id }}">
                <input type="hidden" name="action" value="delete">
                <button class="danger">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% endif %}
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π -->
  <div id="quickModal" class="modal">
    <div class="modal-content">
      <h3>–ë—ã—Å—Ç—Ä–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ</h3>
      <div id="modalContent"></div>
      <div class="modal-actions">
        <button onclick="document.getElementById('quickModal').classList.remove('show')">–û—Ç–º–µ–Ω–∞</button>
        <button class="primary" onclick="submitQuickAction()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
    function showDeviceInfo(deviceId) {
      fetch(`/api/device_full_info?device_id=${encodeURIComponent(deviceId)}`)
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            const dev = data.device;
            const txCount = dev.tx_history ? dev.tx_history.length : 0;
            let html = `
              <div style="margin-bottom: 16px">
                <h4>${dev.device_id}</h4>
                <div class="small muted">–°–æ–∑–¥–∞–Ω–æ: ${dev.created_at || '‚Äî'}</div>
                <div class="small muted">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: ${dev.last_seen || '‚Äî'}</div>
              </div>
              
              <div style="margin-bottom: 16px">
                <strong>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</strong>
                <div>DEV —Ä–µ–∂–∏–º: ${dev.dev_mode ? '‚úÖ –í–∫–ª—é—á–µ–Ω' : '‚ùå –í—ã–∫–ª—é—á–µ–Ω'}</div>
                <div>–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞: ${dev.sub_active ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</div>
                <div>–ò—Å—Ç–µ–∫–∞–µ—Ç: ${dev.sub_expires_at || '‚Äî'}</div>
                <div>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫: ${dev.free_left}</div>
              </div>
              
              <div style="margin-bottom: 16px">
                <strong>–ü–ª–∞—Ç–µ–∂–∏ (–≤—Å–µ–≥–æ: ${txCount}):</strong>
            `;
            
            if (txCount > 0) {
              html += '<div style="max-height: 200px; overflow-y: auto; margin-top: 8px">';
              dev.tx_history.slice().reverse().forEach(tx => {
                html += `
                  <div style="border-left: 2px solid var(--blue); padding-left: 8px; margin-bottom: 8px">
                    <div>TX: ${tx.tx || '‚Äî'}</div>
                    <div>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${tx.comment || '‚Äî'}</div>
                    <div>–ü–ª–∞–Ω: ${tx.plan || '‚Äî'} (${tx.plan_days || '?'} –¥–Ω–µ–π)</div>
                    <div>–¶–µ–Ω–∞: ${tx.plan_price || '‚Äî'}</div>
                    <div class="small muted">${tx.at || '‚Äî'}</div>
                  </div>
                `;
              });
              html += '</div>';
            } else {
              html += '<div class="muted small">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π</div>';
            }
            
            html += '</div>';
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('quickModal').classList.add('show');
          }
        });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
    function submitQuickAction() {
      // –õ–æ–≥–∏–∫–∞ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
      document.getElementById('quickModal').classList.remove('show');
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.getElementById('quickModal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('show');
      }
    });
  </script>
</body>
</html>
