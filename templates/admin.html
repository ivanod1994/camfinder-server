<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>{{ app_name }}</title>
<style>
body{background:#0d1117;color:#fff;font-family:Arial,Helvetica,sans-serif;margin:20px;}
h2{color:#58a6ff;margin:0 0 10px;}
h3{margin-top:28px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #333;padding:8px;text-align:left;vertical-align:top;}
th{background:#161b22;}
tr:nth-child(even){background:#1f242c;}
.btn{background:#238636;border:none;padding:6px 10px;border-radius:4px;color:#fff;cursor:pointer}
.btn:hover{background:#2ea043}
.btn-red{background:#d43c3c}
.btn-red:hover{background:#f04747}
.btn-blue{background:#1f6feb}
.btn-blue:hover{background:#2b74ff}
.red{color:#ff5555;font-weight:bold}
.card{background:#0f141b;border:1px solid #202938;border-radius:8px;padding:12px;margin-top:10px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row .card{flex:1 1 320px}
.small{opacity:.8;font-size:.9em}
.right{float:right}
</style>
</head>
<body>

<h2>CamFinder Admin Panel</h2>

<div class="row">
  <div class="card">
    <b>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É</b>
    <div class="small">–ü–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π <code>ADMIN_PASS</code> –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.</div>
    <div style="margin-top:8px">
      <input id="pwd" type="password" placeholder="–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞" style="width:220px;padding:6px">
      <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
      <button class="btn btn-red" onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
  </div>
  <div class="card">
    <b>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</b>
    <div style="margin-top:6px">
      <input id="act_device" placeholder="device_id" style="width:260px;padding:6px">
      <button class="btn btn-blue" onclick="activate30()">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å 30 –¥–Ω–µ–π</button>
      <button class="btn" onclick="devOn()">Dev ON</button>
      <button class="btn btn-red" onclick="devOff()">Dev OFF</button>
      <button class="btn btn-red" onclick="free0()">free_left = 0</button>
      <button class="btn" onclick="free3()">free_left = 3</button>
    </div>
  </div>
</div>

<h3>üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h3>
<table>
  <tr>
    <th>ID</th><th>–ê–∫—Ç–∏–≤–Ω–∞</th><th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th><th>Free Left</th><th>Dev</th><th>–°–æ–∑–¥–∞–Ω–æ</th><th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th><th>Last seen</th>
  </tr>
  {% for d in devices %}
  <tr>
    <td>{{ d['device_id'] }}</td>
    <td>{{ '‚úÖ' if d['sub_active'] else '‚ùå' }}</td>
    <td>{{ d['sub_expires_at'] or '-' }}</td>
    <td>{{ d['free_left'] }}</td>
    <td>{{ 'üß©' if d['dev_mode'] else '-' }}</td>
    <td class="small">{{ d['created_at'] }}</td>
    <td class="small">{{ d['updated_at'] }}</td>
    <td class="small">{{ d['last_seen'] or '-' }}</td>
  </tr>
  {% endfor %}
</table>

<h3>üí≥ –ó–∞—è–≤–∫–∏ (TX / –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)</h3>
<table>
  <tr>
    <th>–í—Ä–µ–º—è</th><th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th><th class="red">TX</th><th class="red">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th>
  </tr>
  {% for p in payments %}
  <tr>
    <td>{{ p['created_at'] }}</td>
    <td>{{ p['device_id'] }}</td>
    <td class="red">{{ p['tx'] or '-' }}</td>
    <td class="red">{{ p['comment'] or '-' }}</td>
    <td>{{ p['status'] }}</td>
    <td><button class="btn btn-blue" onclick="activatePay('{{ p['device_id'] }}')">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å 30 –¥–Ω–µ–π</button></td>
  </tr>
  {% endfor %}
</table>

<script>
async function post(url, body){
  const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})});
  return r;
}
async function login(){
  const password = document.getElementById('pwd').value;
  const r = await post('/api/admin/auth',{password});
  alert(r.ok?'OK':'–û—à–∏–±–∫–∞ –ø–∞—Ä–æ–ª—è');
}
async function logout(){
  await post('/api/admin/logout',{});
  alert('–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
}
function getDid(){ return document.getElementById('act_device').value.trim(); }
async function activate30(){
  const device_id = getDid(); if(!device_id) return alert('–£–∫–∞–∂–∏ device_id');
  const r = await post('/api/admin/activate',{device_id,days:30});
  alert(r.ok?'–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ':'–û—à–∏–±–∫–∞');
}
async function activatePay(device_id){
  const r = await post('/api/admin/activate',{device_id,days:30});
  alert(r.ok?'–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ':'–û—à–∏–±–∫–∞');
}
async function devOn(){
  const device_id = getDid(); if(!device_id) return alert('–£–∫–∞–∂–∏ device_id');
  const r = await post('/api/admin/dev_mode',{device_id,enable:true});
  alert(r.ok?'Dev ON':'–û—à–∏–±–∫–∞');
}
async function devOff(){
  const device_id = getDid(); if(!device_id) return alert('–£–∫–∞–∂–∏ device_id');
  const r = await post('/api/admin/dev_mode',{device_id,enable:false});
  alert(r.ok?'Dev OFF':'–û—à–∏–±–∫–∞');
}
async function free0(){
  const device_id = getDid(); if(!device_id) return alert('–£–∫–∞–∂–∏ device_id');
  const r = await post('/api/admin/set_free_left',{device_id,value:0});
  alert(r.ok?'free_left=0':'–û—à–∏–±–∫–∞');
}
async function free3(){
  const device_id = getDid(); if(!device_id) return alert('–£–∫–∞–∂–∏ device_id');
  const r = await post('/api/admin/set_free_left',{device_id,value:3});
  alert(r.ok?'free_left=3':'–û—à–∏–±–∫–∞');
}
</script>

</body>
</html>
